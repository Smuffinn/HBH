{% extends 'HarborHop/booking_template.html' %}

{% block booking_title %}Boracay Express Booking{% endblock %}
{% block package_image %}https://static1.detourista.com/wp/wp-content/uploads/Unorganized/Boracay-Spots-Featured.jpg{% endblock %}
{% block package_name %}Boracay{% endblock %}
{% block badge_text %}30% OFF{% endblock %}
{% block package_title %}{{ route.departure_port }} ↔ {{ route.arrival_port }} Express{% endblock %}
{% block price %}₱{{ route.base_price }} per person{% endblock %}

{% block package_features %}
    <li>Valid until June 2024</li>
    <li>Direct ferry service</li>
    <li>Free terminal transfer</li>
    <li>Journey duration: {{ route.duration }}</li>
    <li>Distance: {{ route.distance }} nautical miles</li>
{% endblock %}

{% block booking_form %}
<form method="POST" action="{% url 'payment' %}" class="booking-form">
    {% csrf_token %}
    
    <input type="hidden" name="package_type" value="boracay_express">
    <input type="hidden" name="base_price" value="{{ route.base_price }}">
    
    <div class="form-group">
        <label>Travel Date</label>
        <input type="date" name="travel_date" required id="travel_date"
               min="{{ min_date }}" max="{{ max_date }}">
    </div>
    
    <div class="form-group">
        <label>Available Schedules</label>
        <select name="schedule_id" required id="schedule_select">
            {% if initial_schedules %}
                <option value="">Select a schedule</option>
                {% for schedule in initial_schedules %}
                    <option value="{{ schedule.id }}">
                        {{ schedule.departure_time|date:"g:i A" }} - 
                        {{ schedule.vessel.name }} 
                        ({{ schedule.available_seats }} seats available)
                    </option>
                {% endfor %}
            {% else %}
                <option value="">Select travel date first</option>
            {% endif %}
        </select>
        <small class="text-muted">Please select your preferred departure time</small>
    </div>
    
    <div class="form-group">
        <label>Number of Passengers</label>
        <input type="number" name="passengers" min="1" max="10" required>
    </div>

    <div class="form-group">
        <label>Select Time</label>
        <select name="departure_time" required>
            <option value="morning">Morning (6:00 AM)</option>
            <option value="afternoon">Afternoon (2:00 PM)</option>
        </select>
    </div>

    <div class="form-group">
        <label>Name</label>
        <input type="text" name="name" required value="{{ request.user.get_full_name }}">
    </div>

    <div class="form-group">
        <label>Email</label>
        <input type="email" name="email" required value="{{ request.user.email }}">
    </div>

    <div class="form-group">
        <label>Phone Number</label>
        <input type="tel" name="phone_number" required>
    </div>

    <div class="form-group">
        <label>Gender</label>
        <select name="gender" required>
            <option value="M">Male</option>
            <option value="F">Female</option>
            <option value="O">Other</option>
        </select>
    </div>

    <div class="form-group">
        <label>Age</label>
        <input type="number" name="age" required min="0">
    </div>

    <button type="submit" class="checkout-btn">Proceed to Checkout</button>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('travel_date');
    const scheduleSelect = document.getElementById('schedule_select');

    dateInput.addEventListener('change', async function() {
        const date = this.value;
        if (!date) return;

        // Show loading state
        scheduleSelect.innerHTML = '<option value="">Loading schedules...</option>';
        scheduleSelect.disabled = true;

        try {
            // Make API call
            const response = await fetch(`/api/schedules/available/?route={{ route.id }}&date=${date}`);
            if (!response.ok) throw new Error('Failed to fetch schedules');
            
            const schedules = await response.json();
            scheduleSelect.innerHTML = '<option value="">Select a schedule</option>';
            
            if (!Array.isArray(schedules) || schedules.length === 0) {
                scheduleSelect.innerHTML += '<option value="" disabled>No schedules available for this date</option>';
                return;
            }
            
            schedules.forEach(schedule => {
                const departureTime = new Date(schedule.departure_time);
                const option = document.createElement('option');
                option.value = schedule.id;
                option.textContent = `${departureTime.toLocaleTimeString()} - ${schedule.vessel__name} (${schedule.available_seats} seats available)`;
                scheduleSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error:', error);
            scheduleSelect.innerHTML = '<option value="">Error loading schedules</option>';
        } finally {
            scheduleSelect.disabled = false;
        }
    });
});
</script>
{% endblock %}